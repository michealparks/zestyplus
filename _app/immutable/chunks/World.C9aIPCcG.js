import{c as z,a as O}from"./disclose-version.hHKxC-Jk.js";import{aG as ee,b as ae,h as T,f as te,aH as re,N as I,q as ne,U as F,Z as H,Y as q,ap as G,ax as J,aI as K,l as k,a as D,p as A,aF as ie,c as se,x as oe,a0 as V,e as le,v as U,a6 as ce,a2 as x,n as E,a1 as X,z as fe}from"./runtime.BZbTZrfI.js";import{s as W}from"./snippet.BOLubvD_.js";import{a as Z,s as ue,r as de}from"./props.DC6YhwhV.js";import{O as j,s as w,j as me,k as he}from"./createCollidersFromChildren.ChtovUMO.js";import{a as ge}from"./index-client.DPkCdMtJ.js";import{a as p,c as N}from"./T.DXVn7S3O.js";import{w as L,d as ye}from"./index.Bijh3cPG.js";const M=0,b=1,R=2;function ve(s,e,t,a,r){T&&te();var n=s,o=ee(),h=oe,l=F,f,u,c,S=(o?H:q)(void 0),_=(o?H:q)(void 0),g=!1;function d(i,y){g=!0,y&&(G(v),J(v),K(h));try{i===M&&t&&(f?k(f):f=D(()=>t(n))),i===b&&a&&(u?k(u):u=D(()=>a(n,S))),i===R&&r&&(c?k(c):c=D(()=>r(n,_))),i!==M&&f&&A(f,()=>f=null),i!==b&&u&&A(u,()=>u=null),i!==R&&c&&A(c,()=>c=null)}finally{y&&(K(null),J(null),G(null),ie())}}var v=ae(()=>{if(l!==(l=e())){if(re(l)){var i=l;g=!1,i.then(y=>{i===l&&(I(S,y),d(b,!0))},y=>{if(i===l&&(I(_,y),d(R,!0),!r))throw _.v}),T||ne(()=>{g||d(M,!0)})}else I(S,l),d(b,!1);return()=>l=F}});T&&(n=se)}function Q(s,e){const{scheduler:t}=p();return t.getStage(s)??t.createStage(s,e)}let Y=!1,B;const Se=()=>Y?!0:(B||(B=new Promise(s=>{j.init().then(()=>{Y=!0,s()})})),B),_e=(s,e,t,a)=>{var u,c,S,_;let r=0,n=0,o=0;const{renderStage:h}=p(),l=Q(w,{after:(u=a==null?void 0:a.simulationStageOptions)==null?void 0:u.after,before:(c=a==null?void 0:a.simulationStageOptions)==null?void 0:c.before,callback(g,d){if(s.current==="varying")d();else{const v=1/s.current;n+=g,r+=g;const i=Math.ceil(r/v);for(let y=0;y<i;y++)t.set(y>=i-2),d(v),r-=v,o+=v;e.set((n-o)/v+1)}}}),f=Q(me,{after:(S=a==null?void 0:a.synchronizationStageOptions)!=null&&S.after?Array.isArray(a.synchronizationStageOptions.after)?[...a.synchronizationStageOptions.after,w]:[a.synchronizationStageOptions.after,w]:w,before:(_=a==null?void 0:a.synchronizationStageOptions)!=null&&_.before?Array.isArray(a.synchronizationStageOptions.before)?[...a.synchronizationStageOptions.before,h]:[a.synchronizationStageOptions.before,h]:h});return{simulationStage:l,synchronizationStage:f}},we=(s,e)=>{const t=new j.World(...s),a=new Map,r=new Map,n=new Map,o=new Map,h=(m,C,P)=>{a.set(m.handle,C),o.set(m.handle,P)},l=m=>{a.delete(m.handle),o.delete(m.handle)},f=(m,C,P)=>{r.set(m.handle,C),n.set(m.handle,P)},u=m=>{r.delete(m.handle),n.delete(m.handle)},c=N(e.framerate??"varying"),S=N(1),_=N(c.current==="varying"),{simulationStage:g,synchronizationStage:d}=_e(c,S,_,e),v=e.autoStart??!0,i=L(!v);v||(g.stop(),d.stop());const{simulationTask:y,synchronizationTask:$}=he(t,c,S,r,_,o,n,g,d);return{rapier:j,world:t,colliderObjects:a,rigidBodyObjects:r,rigidBodyEventDispatchers:n,colliderEventDispatchers:o,addColliderToContext:h,removeColliderFromContext:l,addRigidBodyToContext:f,removeRigidBodyFromContext:u,debug:L(!1),pause:()=>{i.set(!0),g.stop(),d.stop()},resume:()=>{i.set(!1),g.start(),d.start()},paused:ye(i,m=>m),framerate:c,simulationOffset:S,simulationStage:g,synchronizationStage:d,updateRigidBodySimulationData:_,simulationTask:y,synchronizationTask:$}};function be(s,e){V(e,!0);let t=Z(e,"gravity",19,()=>[0,-9.81,0]),a=Z(e,"autoStart",3,!0);const r=we([{x:t()[0],y:t()[1],z:t()[2]},e.rawIntegrationParameters,e.rawIslands,e.rawBroadPhase,e.rawNarrowPhase,e.rawBodies,e.rawColliders,e.rawImpulseJoints,e.rawMultibodyJoints,e.rawCCDSolver,e.rawQueryPipeline,e.rawPhysicsPipeline,e.rawSerializationPipeline,e.rawDebugRenderPipeline],{framerate:e.framerate,autoStart:a(),simulationStageOptions:e.simulationStageOptions,synchronizationStageOptions:e.synchronizationStageOptions});le("threlte-rapier-context",r),U(()=>{t()!==void 0&&(r.world.gravity={x:t()[0],y:t()[1],z:t()[2]})}),U(()=>{e.framerate!==void 0&&r.framerate.set(e.framerate)}),ge(async()=>{await ce(),r.world.free()});var n=z(),o=x(n);W(o,()=>e.children??E),O(s,n),X()}function De(s,e){V(e,!0);let t=de(e,["$$slots","$$events","$$legacy","fallback","children"]);var a=z(),r=x(a);ve(r,Se,null,(n,o)=>{be(n,ue(()=>t,{children:(h,l)=>{var f=z(),u=x(f);W(u,()=>e.children??E),O(h,f)},$$slots:{default:!0}}))},(n,o)=>{var h=z(),l=x(h);W(l,()=>e.fallback??E,()=>fe(o)),O(n,h)}),O(s,a),X()}export{De as W};
