import"./DsnmJJEf.js";import{a3 as q,ah as v,d as S,i as c,a2 as H,a6 as w,a1 as L,as as R,a8 as b,a9 as j,a5 as Q}from"./Wk8iZnnz.js";import{e as U,i as X}from"./GTp4Qb7F.js";import{c as A}from"./BXm_g8N-.js";import{p as _}from"./oafpEiTJ.js";import{g1 as Y,V as f,f_ as Z,g5 as $,f$ as D}from"./CtU81MLD.js";import{l as tt}from"./BJsdZ20B.js";import{d as et,w as p,a as rt,g as nt}from"./DLMcqm7y.js";import{c as st,R as ot}from"./DRNreWhG.js";import{C as at}from"./DKfvhTNW.js";const it=a=>{const t=p(void 0),l=p(void 0),u=st(),s=et([t,l],([e,r])=>{if(e&&r)return[e,r]}),g=p(void 0),i=s.subscribe(e=>{e&&g.set(a(...e,u))});return rt(()=>{i();const e=nt(g);e&&(e instanceof tt?u.world.removeMultibodyJoint(e,!0):u.world.removeImpulseJoint(e,!0))}),{joint:g,rigidBodyA:t,rigidBodyB:l}},V=a=>Y(a,"Vector3"),dt=(a,t,l)=>it((u,s,{world:g,rapier:i})=>{const e=V(a)?a:new f(...a),r=V(t)?t:new f(...t),m=i.JointData.rope(l,e,r);return g.createImpulseJoint(m,u,s,!0)});function jt(a,t){q(t,!0);let l=_(t,"startRigidBody",15),u=_(t,"lastRigidBody",15),s=_(t,"positions",15),g=w(()=>t.length/(t.segments-1)),i=H(!1);const e=w(()=>Array.from({length:t.segments-1},()=>dt([0,0,0],[0,0,0],c(g))));s(new Float32Array(t.segments));const r=v([]);S(()=>{l(r.at(0)),u(r.at(-1))});const m=v([]),z=new f().fromArray(t.ropeStart),E=new f().fromArray(t.ropeEnd),T=n=>{const o=n/(t.segments-1);return z.clone().lerp(E,o)};S(()=>{r.length!==t.segments||m.length!==t.segments||c(i)||(c(e).forEach((n,o)=>{n.rigidBodyA.set(r[o]),n.rigidBodyB.set(r[o+1])}),L(i,!0))}),v(Array.from({length:t.segments},()=>new f(0,0,0)));const y=new f;Z(()=>{if(c(i))for(let n=0,o=0,d=m.length;n<d;n+=1,o+=3)m[n]?.getWorldPosition(y),s(s()[o+0]=y.x,!0),s(s()[o+1]=y.y,!0),s(s()[o+2]=y.z,!0)}),$(()=>[c(i),t.ropeStart,t.ropeEnd],([n])=>{n&&l()?.setNextKinematicTranslation({x:t.ropeStart[0],y:t.ropeStart[1],z:t.ropeStart[2]})});var I=R(),k=b(I);U(k,17,()=>({length:t.segments}),X,(n,o,d)=>{var J=R(),C=b(J);A(C,()=>D.Group,(O,x)=>{x(O,{oncreate:B=>{B.position.copy(T(d))},children:(B,lt)=>{ot(B,{get linearDamping(){return t.damping},get angularDamping(){return t.damping},type:d===0?"kinematicPosition":"dynamic",get rigidBody(){return r[d]},set rigidBody(h){r[d]=h},children:(h,ut)=>{{let F=w(()=>[t.ballRadius]);at(h,{shape:"ball",get args(){return c(F)},children:(G,gt)=>{var P=R(),K=b(P);A(K,()=>D.Object3D,(M,N)=>{N(M,{get ref(){return m[d]},set ref(W){m[d]=W}})}),j(G,P)},$$slots:{default:!0}})}},$$slots:{default:!0}})},$$slots:{default:!0}})}),j(n,J)}),j(a,I),Q()}export{jt as default};
