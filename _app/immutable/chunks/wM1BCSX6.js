import{l as dt,b as Z,a1 as $,a2 as mt,f as g,s as Mt}from"./DGLrSMKY.js";const tt=Symbol("analyser-context"),yt=()=>{let s=mt(void 0),d,D;const j=1024,m=128,N=-80,J=-30,et=.8,at=.35,nt=.08,rt=20,ot=16e3,st=.06,lt=10;let v=new Uint8Array,A=new Float32Array,r=new Float32Array,V=new Float32Array(m),H=new Float32Array(m),E=new Float32Array,L=0,K=0,y=0,R=0,T=0,p=0,W=0,x=0,O=0,P=0,q=0,B=0,Q=!1,X=0,z=0,F=0,S=0,Y=!1,G=0,a={bass:0,lowMid:0,mid:0,highMid:0,treble:0,air:0},_=0,U=0,I=[],n={bass:{a:0,b:0},lowMid:{a:0,b:0},mid:{a:0,b:0},highMid:{a:0,b:0},treble:{a:0,b:0},air:{a:0,b:0}};const M=e=>Math.max(0,Math.min(1,e)),it=(e,o,c)=>e+(o-e)*c,ct=e=>M((e-N)/(J-N)),i=e=>_?Math.max(0,Math.min(r.length-1,Math.round(e/_))):0,w=(e,o,c)=>{if(c<o)return 0;let b=0,h=0;for(let f=o;f<=c;f++)b+=e[f],h++;return h?b/h:0},gt=(e,o=.02,c=1.6)=>{const b=Math.max(0,e-o)/(1-o);return Math.pow(M(b),1/c)},ht=()=>{if(!g(s)||!d)return;U=d.sampleRate,_=U/g(s).fftSize;const e=rt,o=Math.min(ot,U/2),c=Math.log(e),b=Math.log(o);I=new Array(m);for(let h=0;h<m;h++){const f=Math.exp(c+h/m*(b-c)),k=Math.exp(c+(h+1)/m*(b-c)),t=i(f),l=i(k);I[h]={a:t,b:Math.max(t,l)}}n.bass={a:i(20),b:i(150)},n.lowMid={a:i(150),b:i(400)},n.mid={a:i(400),b:i(1200)},n.highMid={a:i(1200),b:i(3e3)},n.treble={a:i(3e3),b:i(8e3)},n.air={a:i(8e3),b:i(16e3)}},ut=async()=>{try{D=await navigator.mediaDevices.getUserMedia({audio:{backgroundBlur:!1,echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1}}),d=new AudioContext;const e=d.createMediaStreamSource(D);$(s,d.createAnalyser()),g(s).fftSize=j,g(s).smoothingTimeConstant=et,g(s).minDecibels=N,g(s).maxDecibels=J,e.connect(g(s));const o=g(s).frequencyBinCount;v=new Uint8Array(g(s).fftSize),A=new Float32Array(o),r=new Float32Array(o),E=new Float32Array(o),V=new Float32Array(m),H=new Float32Array(m),ht()}catch(e){console.error("Error accessing microphone:",e)}},bt=()=>{if(!g(s)||!d)return;g(s).getFloatFrequencyData(A);for(let t=0;t<A.length;t++)r[t]=ct(A[t]);for(let t=0;t<I.length;t++){const{a:l,b:u}=I[t],C=w(r,l,u);V[t]=C,H[t]=it(H[t],C,.25)}a.bass=w(r,n.bass.a,n.bass.b),a.lowMid=w(r,n.lowMid.a,n.lowMid.b),a.mid=w(r,n.mid.a,n.mid.b),a.highMid=w(r,n.highMid.a,n.highMid.b),a.treble=w(r,n.treble.a,n.treble.b),a.air=w(r,n.air.a,n.air.b),g(s).getByteTimeDomainData(v);let e=0,o=0;for(let t=0,l=v.length;t<l;t++){const u=(v[t]-128)/128,C=Math.abs(u);C>o&&(o=C),e+=u*u}L=Math.sqrt(e/v.length),K=o;const c=L,b=c>y?at:nt;y+=(c-y)*b,R+=(y-R)*.03,T=Math.max(0,y-R);{const u=(a.bass*.4+a.lowMid*.8+a.mid*1+a.highMid*.9+a.treble*.7+a.air*.4)/4.2;p+=(u-p)*.2,p=M(p)}W=gt(p),G=W>st?lt:Math.max(0,G-1),Y=G>0;let h=0;for(let t=0;t<r.length;t++){const l=r[t]-E[t];l>0&&(h+=l),E[t]=r[t]}x=h/r.length;{q+=(x-q)*.05,B+=(Math.abs(x-q)-B)*.05;const t=q+2*B;Q=x>t,X=M((x-t)/(1e-4+3*B))}let f=0,k=0;for(let t=0;t<r.length;t++){const l=r[t],u=t*(U/j);f+=u*l,k+=l}O=k>0?f/k:0;{const t=(a.bass+a.lowMid+a.mid)/3,l=(a.highMid+a.treble+a.air)/3;P=M((l-t)*.75+.5)*2-1}{const t=a.bass*.9+T*.6,l=a.highMid*.9+T*.4,u=a.treble*.9+a.air*.7;z+=(t-z)*.3,F+=(l-F)*.3,S+=(u-S)*.25,z=M(z),F=M(F),S=M(S)}};Z(()=>(ut(),()=>{try{D?.getTracks().forEach(e=>e.stop())}catch{}try{d?.close()}catch{}D=void 0,d=void 0,$(s,void 0)})),Z(()=>{if(g(s)){const e=setInterval(bt,41.666666666666664);return()=>clearInterval(e)}}),Mt(tt,{get current(){return g(s)},get spectrumDb(){return A},get spectrum01(){return r},get log01(){return V},get logSmooth01(){return H},get bands(){return a},get rms(){return L},get peak(){return K},get level(){return y},get slowLevel(){return R},get punch(){return T},get loudness(){return p},get energyCurve(){return W},get flux(){return x},get onset(){return Q},get onsetStrength(){return X},get centroidHz(){return O},get tilt(){return P},get kick(){return z},get snare(){return F},get hat(){return S},get active(){return Y}})},pt=()=>dt(tt);export{yt as p,pt as u};
