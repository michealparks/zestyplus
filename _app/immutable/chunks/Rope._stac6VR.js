import"./disclose-version.Bg9kRutz.js";import{ab as W,p as q,b as _,i as c,f as w,a as H,a6 as L,a5 as Q,k as b}from"./index-client.CAJtLLOW.js";import{c as R,a as j}from"./template.CuXd8n4y.js";import{e as U,i as X}from"./each.C1gUuVZd.js";import{c as A}from"./svelte-component.DNJIJZlw.js";import{p,a as I}from"./props.BHX9ZFdi.js";import{n as Z,V as f,h as $,o as tt,d as D}from"./T.Dho_lh33.js";import{c as et,Y as rt,i as nt}from"./createCollidersFromChildren.DAmjNsIo.js";import{d as st,g as ot,w as J}from"./index.XGZQr0eJ.js";import{C as it}from"./Collider.BAea8TzE.js";const at=a=>{const t=J(void 0),l=J(void 0),u=et(),s=st([t,l],([e,r])=>{if(e&&r)return[e,r]}),m=J(void 0),d=s.subscribe(e=>{e&&m.set(a(...e,u))});return W(()=>{d();const e=ot(m);e&&(e instanceof rt?u.world.removeMultibodyJoint(e,!0):u.world.removeImpulseJoint(e,!0))}),{joint:m,rigidBodyA:t,rigidBodyB:l}},V=a=>Z(a,"Vector3"),dt=(a,t,l)=>at((u,s,{world:m,rapier:d})=>{const e=V(a)?a:new f(...a),r=V(t)?t:new f(...t),g=d.JointData.rope(l,e,r);return m.createImpulseJoint(g,u,s,!0)});function jt(a,t){q(t,!0);let l=p(t,"startRigidBody",15),u=p(t,"lastRigidBody",15),s=p(t,"positions",15),m=b(()=>t.length/(t.segments-1)),d=L(!1);const e=b(()=>Array.from({length:t.segments-1},()=>dt([0,0,0],[0,0,0],c(m))));s(new Float32Array(t.segments));const r=I([]);_(()=>{l(r.at(0)),u(r.at(-1))});const g=I([]),k=new f().fromArray(t.ropeStart),z=new f().fromArray(t.ropeEnd),E=o=>{const n=o/(t.segments-1);return k.clone().lerp(z,n)};_(()=>{r.length!==t.segments||g.length!==t.segments||c(d)||(c(e).forEach((o,n)=>{o.rigidBodyA.set(r[n]),o.rigidBodyB.set(r[n+1])}),Q(d,!0))}),I(Array.from({length:t.segments},()=>new f(0,0,0)));const y=new f;$(()=>{var o;if(c(d))for(let n=0,i=0,B=g.length;n<B;n+=1,i+=3)(o=g[n])==null||o.getWorldPosition(y),s(s()[i+0]=y.x,!0),s(s()[i+1]=y.y,!0),s(s()[i+2]=y.z,!0)}),tt(()=>[c(d),t.ropeStart,t.ropeEnd],([o])=>{var n;o&&((n=l())==null||n.setNextKinematicTranslation({x:t.ropeStart[0],y:t.ropeStart[1],z:t.ropeStart[2]}))});var P=R(),T=w(P);U(T,17,()=>({length:t.segments}),X,(o,n,i)=>{var B=R(),C=w(B);A(C,()=>D.Group,(O,Y)=>{Y(O,{oncreate:h=>{h.position.copy(E(i))},children:(h,lt)=>{nt(h,{get linearDamping(){return t.damping},get angularDamping(){return t.damping},type:i===0?"kinematicPosition":"dynamic",get rigidBody(){return r[i]},set rigidBody(v){r[i]=v},children:(v,ut)=>{var x=b(()=>[t.ballRadius]);it(v,{shape:"ball",get args(){return c(x)},children:(F,mt)=>{var S=R(),G=w(S);A(G,()=>D.Object3D,(K,M)=>{M(K,{get ref(){return g[i]},set ref(N){g[i]=N}})}),j(F,S)},$$slots:{default:!0}})},$$slots:{default:!0}})},$$slots:{default:!0}})}),j(o,B)}),j(a,P),H()}export{jt as default};
