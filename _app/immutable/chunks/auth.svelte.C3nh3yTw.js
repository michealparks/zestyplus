var h=e=>{throw TypeError(e)};var x=(e,t,r)=>t.has(e)||h("Cannot "+r);var i=(e,t,r)=>(x(e,t,"read from private field"),r?r.call(e):t.get(e)),p=(e,t,r)=>t.has(e)?h("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,r);import{C as I,z as T,D as U}from"./runtime.BZbTZrfI.js";import{p as b}from"./props.DC6YhwhV.js";const l="c80e549f03864691a94b026c06619501",d="https://zesty.plus",A="https://accounts.spotify.com/authorize",g="https://accounts.spotify.com/api/token",P=["user-read-private","user-read-email","user-read-playback-state","user-read-currently-playing"].join(" "),c={get access(){return localStorage.getItem("access_token")??""},get refresh(){return localStorage.getItem("refresh_token")??""},get expiresIn(){return localStorage.getItem("refresh_in")??""},get expires(){return localStorage.getItem("expires")??""}},w=e=>{const{access_token:t,refresh_token:r,expires_in:o}=e;localStorage.setItem("access_token",t),localStorage.setItem("refresh_token",r),localStorage.setItem("expires_in",o);const n=Date.now(),s=new Date(n+Number(o)*1e3);localStorage.setItem("expires",s.toString())},v=async()=>{const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o=crypto.getRandomValues(new Uint8Array(64)).reduce((S,k)=>S+e[k%e.length],""),n=new TextEncoder().encode(o),s=await crypto.subtle.digest("SHA-256",n),y=btoa(String.fromCharCode(...new Uint8Array(s))).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_");window.localStorage.setItem("code_verifier",o);const u=new URL(A),_={response_type:"code",client_id:l,scope:P,code_challenge_method:"S256",code_challenge:y,redirect_uri:d};u.search=new URLSearchParams(_).toString(),window.location.href=u.toString()},z=async e=>{const t=localStorage.getItem("code_verifier");return await(await fetch(g,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({client_id:l,grant_type:"authorization_code",code:e,redirect_uri:d,code_verifier:t??""})})).json()},R=async()=>{const t=await(await fetch(g,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({client_id:l,grant_type:"refresh_token",refresh_token:c.refresh??""})})).json();if(t.error)return!0;w(t)},C=async()=>(await fetch("https://api.spotify.com/v1/me",{headers:{Authorization:`Bearer ${c.access}`}})).json(),L=async e=>new Promise(t=>{setTimeout(t,e)}),m=async()=>{var r;const t=new URLSearchParams(window.location.search).get("code");if(t){const o=await z(t);w(o);const n=new URL(window.location.href);n.searchParams.delete("code");const s=n.search?n.href:n.href.replace("?","");window.history.replaceState({},document.title,s)}if(c.access){const o=await C();return((r=o.error)==null?void 0:r.status)===401?await R()?{state:"logged-out"}:(await L(2e3),m()):{state:"logged-in",userData:o}}return{state:"logged-out"}},D=()=>v(),j=async()=>{localStorage.clear(),window.location.href=d};var a;class V{constructor(){p(this,a,I("pending"))}get current(){return T(i(this,a))}set current(t){U(i(this,a),b(t))}}a=new WeakMap;const f=new V;m().then(({state:e})=>{f.current=e});const E={token:c,authenticated:f,login:D,logout:j},N=()=>E;export{N as u};
