import"./disclose-version.Bg9kRutz.js";import{aG as ee,v as ae,w as T,x as te,aH as re,O as k,q as ne,U as j,$ as H,_ as q,ar as G,ax as J,aI as K,B as I,C as D,D as A,aF as ie,F as se,e as oe,p as X,b as le,u as U,ab as ce,aa as fe,f as O,a2 as E,a as Y,k as ue}from"./index-client.DzQlphmH.js";import{c as x,a as z}from"./template.CgCchT00.js";import{i as p,c as B,s as W}from"./T.D9_Xg1XW.js";import{p as L,s as de,r as me}from"./props.DHXOHPV0.js";import{O as F,s as w,j as he,k as ge}from"./createCollidersFromChildren.CGFyc-A4.js";import{w as Q,d as ye}from"./index.DdXxZHS9.js";const M=0,b=1,N=2;function ve(s,e,t,a,r){T&&te();var n=s,o=ee(),h=oe,l=j,f,u,c,_=(o?H:q)(void 0),S=(o?H:q)(void 0),g=!1;function d(i,y){g=!0,y&&(G(v),J(v),K(h));try{i===M&&t&&(f?I(f):f=D(()=>t(n))),i===b&&a&&(u?I(u):u=D(()=>a(n,_))),i===N&&r&&(c?I(c):c=D(()=>r(n,S))),i!==M&&f&&A(f,()=>f=null),i!==b&&u&&A(u,()=>u=null),i!==N&&c&&A(c,()=>c=null)}finally{y&&(K(null),J(null),G(null),ie())}}var v=ae(()=>{if(l!==(l=e())){if(re(l)){var i=l;g=!1,i.then(y=>{i===l&&(k(_,y),d(b,!0))},y=>{if(i===l&&(k(S,y),d(N,!0),!r))throw S.v}),T||ne(()=>{g||d(M,!0)})}else k(_,l),d(b,!1);return()=>l=j}});T&&(n=se)}function Z(s,e){const{scheduler:t}=p();return t.getStage(s)??t.createStage(s,e)}let V=!1,R;const _e=()=>V?!0:(R||(R=new Promise(s=>{F.init().then(()=>{V=!0,s()})})),R),Se=(s,e,t,a)=>{var u,c,_,S;let r=0,n=0,o=0;const{renderStage:h}=p(),l=Z(w,{after:(u=a==null?void 0:a.simulationStageOptions)==null?void 0:u.after,before:(c=a==null?void 0:a.simulationStageOptions)==null?void 0:c.before,callback(g,d){if(s.current==="varying")d();else{const v=1/s.current;n+=g,r+=g;const i=Math.ceil(r/v);for(let y=0;y<i;y++)t.set(y>=i-2),d(v),r-=v,o+=v;e.set((n-o)/v+1)}}}),f=Z(he,{after:(_=a==null?void 0:a.synchronizationStageOptions)!=null&&_.after?Array.isArray(a.synchronizationStageOptions.after)?[...a.synchronizationStageOptions.after,w]:[a.synchronizationStageOptions.after,w]:w,before:(S=a==null?void 0:a.synchronizationStageOptions)!=null&&S.before?Array.isArray(a.synchronizationStageOptions.before)?[...a.synchronizationStageOptions.before,h]:[a.synchronizationStageOptions.before,h]:h});return{simulationStage:l,synchronizationStage:f}},we=(s,e)=>{const t=new F.World(...s),a=new Map,r=new Map,n=new Map,o=new Map,h=(m,C,P)=>{a.set(m.handle,C),o.set(m.handle,P)},l=m=>{a.delete(m.handle),o.delete(m.handle)},f=(m,C,P)=>{r.set(m.handle,C),n.set(m.handle,P)},u=m=>{r.delete(m.handle),n.delete(m.handle)},c=B(e.framerate??"varying"),_=B(1),S=B(c.current==="varying"),{simulationStage:g,synchronizationStage:d}=Se(c,_,S,e),v=e.autoStart??!0,i=Q(!v);v||(g.stop(),d.stop());const{simulationTask:y,synchronizationTask:$}=ge(t,c,_,r,S,o,n,g,d);return{rapier:F,world:t,colliderObjects:a,rigidBodyObjects:r,rigidBodyEventDispatchers:n,colliderEventDispatchers:o,addColliderToContext:h,removeColliderFromContext:l,addRigidBodyToContext:f,removeRigidBodyFromContext:u,debug:Q(!1),pause:()=>{i.set(!0),g.stop(),d.stop()},resume:()=>{i.set(!1),g.start(),d.start()},paused:ye(i,m=>m),framerate:c,simulationOffset:_,simulationStage:g,synchronizationStage:d,updateRigidBodySimulationData:S,simulationTask:y,synchronizationTask:$}};function be(s,e){X(e,!0);let t=L(e,"gravity",19,()=>[0,-9.81,0]),a=L(e,"autoStart",3,!0);const r=we([{x:t()[0],y:t()[1],z:t()[2]},e.rawIntegrationParameters,e.rawIslands,e.rawBroadPhase,e.rawNarrowPhase,e.rawBodies,e.rawColliders,e.rawImpulseJoints,e.rawMultibodyJoints,e.rawCCDSolver,e.rawQueryPipeline,e.rawPhysicsPipeline,e.rawSerializationPipeline,e.rawDebugRenderPipeline],{framerate:e.framerate,autoStart:a(),simulationStageOptions:e.simulationStageOptions,synchronizationStageOptions:e.synchronizationStageOptions});le("threlte-rapier-context",r),U(()=>{t()!==void 0&&(r.world.gravity={x:t()[0],y:t()[1],z:t()[2]})}),U(()=>{e.framerate!==void 0&&r.framerate.set(e.framerate)}),ce(async()=>{await fe(),r.world.free()});var n=x(),o=O(n);W(o,()=>e.children??E),z(s,n),Y()}function Ie(s,e){X(e,!0);let t=me(e,["$$slots","$$events","$$legacy","fallback","children"]);var a=x(),r=O(a);ve(r,_e,null,(n,o)=>{be(n,de(()=>t,{children:(h,l)=>{var f=x(),u=O(f);W(u,()=>e.children??E),z(h,f)},$$slots:{default:!0}}))},(n,o)=>{var h=x(),l=O(h);W(l,()=>e.fallback??E,()=>ue(o)),z(n,h)}),z(s,a),Y()}export{Ie as W};
