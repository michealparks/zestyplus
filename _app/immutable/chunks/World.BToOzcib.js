import{c as O,b as z}from"./disclose-version.DFxnx1AN.js";import{aI as ee,b as ae,h as T,q as te,aJ as re,$ as I,O as ne,U as j,a6 as F,a5 as J,ah as q,ag as G,aK as H,K as k,a as D,L as A,aF as ie,c as se,e as oe,B as X,G as ce,Q as L,ac as le,a8 as x,n as E,D as Y,T as fe}from"./runtime.BxeNZxLl.js";import{s as W}from"./snippet.AXKrw6tU.js";import{p as Q,s as ue,r as de}from"./props.CvCzEa8T.js";import{O as K,s as w,j as me,k as he}from"./createCollidersFromChildren.3deb0VN8.js";import{a as ge}from"./index-client.DixpdGuH.js";import{a as p,c as B}from"./T.BojAtv_L.js";import{w as U,d as ye}from"./index.BNeNpGEZ.js";const M=0,b=1,N=2;function ve(s,e,t,a,r){T&&te();var n=s,o=ee(),h=oe,c=j,f,u,l,S=(o?F:J)(void 0),_=(o?F:J)(void 0),g=!1;function d(i,y){g=!0,y&&(q(v),G(v),H(h));try{i===M&&t&&(f?k(f):f=D(()=>t(n))),i===b&&a&&(u?k(u):u=D(()=>a(n,S))),i===N&&r&&(l?k(l):l=D(()=>r(n,_))),i!==M&&f&&A(f,()=>f=null),i!==b&&u&&A(u,()=>u=null),i!==N&&l&&A(l,()=>l=null)}finally{y&&(H(null),G(null),q(null),ie())}}var v=ae(()=>{if(c!==(c=e())){if(re(c)){var i=c;g=!1,i.then(y=>{i===c&&(I(S,y),d(b,!0))},y=>{if(i===c&&(I(_,y),d(N,!0),!r))throw _.v}),T||ne(()=>{g||d(M,!0)})}else I(S,c),d(b,!1);return()=>c=j}});T&&(n=se)}function Z(s,e){const{scheduler:t}=p();return t.getStage(s)??t.createStage(s,e)}let V=!1,R;const Se=()=>V?!0:(R||(R=new Promise(s=>{K.init().then(()=>{V=!0,s()})})),R),_e=(s,e,t,a)=>{var u,l,S,_;let r=0,n=0,o=0;const{renderStage:h}=p(),c=Z(w,{after:(u=a==null?void 0:a.simulationStageOptions)==null?void 0:u.after,before:(l=a==null?void 0:a.simulationStageOptions)==null?void 0:l.before,callback(g,d){if(s.current==="varying")d();else{const v=1/s.current;n+=g,r+=g;const i=Math.ceil(r/v);for(let y=0;y<i;y++)t.set(y>=i-2),d(v),r-=v,o+=v;e.set((n-o)/v+1)}}}),f=Z(me,{after:(S=a==null?void 0:a.synchronizationStageOptions)!=null&&S.after?Array.isArray(a.synchronizationStageOptions.after)?[...a.synchronizationStageOptions.after,w]:[a.synchronizationStageOptions.after,w]:w,before:(_=a==null?void 0:a.synchronizationStageOptions)!=null&&_.before?Array.isArray(a.synchronizationStageOptions.before)?[...a.synchronizationStageOptions.before,h]:[a.synchronizationStageOptions.before,h]:h});return{simulationStage:c,synchronizationStage:f}},we=(s,e)=>{const t=new K.World(...s),a=new Map,r=new Map,n=new Map,o=new Map,h=(m,C,P)=>{a.set(m.handle,C),o.set(m.handle,P)},c=m=>{a.delete(m.handle),o.delete(m.handle)},f=(m,C,P)=>{r.set(m.handle,C),n.set(m.handle,P)},u=m=>{r.delete(m.handle),n.delete(m.handle)},l=B(e.framerate??"varying"),S=B(1),_=B(l.current==="varying"),{simulationStage:g,synchronizationStage:d}=_e(l,S,_,e),v=e.autoStart??!0,i=U(!v);v||(g.stop(),d.stop());const{simulationTask:y,synchronizationTask:$}=he(t,l,S,r,_,o,n,g,d);return{rapier:K,world:t,colliderObjects:a,rigidBodyObjects:r,rigidBodyEventDispatchers:n,colliderEventDispatchers:o,addColliderToContext:h,removeColliderFromContext:c,addRigidBodyToContext:f,removeRigidBodyFromContext:u,debug:U(!1),pause:()=>{i.set(!0),g.stop(),d.stop()},resume:()=>{i.set(!1),g.start(),d.start()},paused:ye(i,m=>m),framerate:l,simulationOffset:S,simulationStage:g,synchronizationStage:d,updateRigidBodySimulationData:_,simulationTask:y,synchronizationTask:$}};function be(s,e){X(e,!0);let t=Q(e,"gravity",19,()=>[0,-9.81,0]),a=Q(e,"autoStart",3,!0);const r=we([{x:t()[0],y:t()[1],z:t()[2]},e.rawIntegrationParameters,e.rawIslands,e.rawBroadPhase,e.rawNarrowPhase,e.rawBodies,e.rawColliders,e.rawImpulseJoints,e.rawMultibodyJoints,e.rawCCDSolver,e.rawQueryPipeline,e.rawPhysicsPipeline,e.rawSerializationPipeline,e.rawDebugRenderPipeline],{framerate:e.framerate,autoStart:a(),simulationStageOptions:e.simulationStageOptions,synchronizationStageOptions:e.synchronizationStageOptions});ce("threlte-rapier-context",r),L(()=>{t()!==void 0&&(r.world.gravity={x:t()[0],y:t()[1],z:t()[2]})}),L(()=>{e.framerate!==void 0&&r.framerate.set(e.framerate)}),ge(async()=>{await le(),r.world.free()});var n=O(),o=x(n);W(o,()=>e.children??E),z(s,n),Y()}function De(s,e){X(e,!0);let t=de(e,["$$slots","$$events","$$legacy","fallback","children"]);var a=O(),r=x(a);ve(r,Se,null,(n,o)=>{be(n,ue(()=>t,{children:(h,c)=>{var f=O(),u=x(f);W(u,()=>e.children??E),z(h,f)},$$slots:{default:!0}}))},(n,o)=>{var h=O(),c=x(h);W(c,()=>e.fallback??E,()=>fe(o)),z(n,h)}),z(s,a),Y()}export{De as W};
