import{c as h,b}from"./disclose-version.DxMWfzFv.js";import{w as Q,O as _,Q as c,a6 as R,y as W,aa as q,ab as H,T as j}from"./runtime.TNfRlsGO.js";import{e as L,i as U}from"./each.DbS8IIVD.js";import{c as A}from"./svelte-component.B5dtG_Db.js";import{p,a as I}from"./props.J8c_Vd-h.js";import{V as f}from"./three.module.iKKkBh6O.js";import{i as X,u as Z,o as $,T as D}from"./T.5NVhIH70.js";import{c as tt,Y as et,i as rt}from"./createCollidersFromChildren.By8NmhRW.js";import{a as nt}from"./index-client.BdRbtj4S.js";import{d as st,g as ot,w as J}from"./index.9TzXr6yC.js";import{C as it}from"./Collider.B1-INJvt.js";const at=a=>{const t=J(void 0),m=J(void 0),u=tt(),s=st([t,m],([e,r])=>{if(e&&r)return[e,r]}),l=J(void 0),d=s.subscribe(e=>{e&&l.set(a(...e,u))});return nt(()=>{d();const e=ot(l);e&&(e instanceof et?u.world.removeMultibodyJoint(e,!0):u.world.removeImpulseJoint(e,!0))}),{joint:l,rigidBodyA:t,rigidBodyB:m}},T=a=>X(a,"Vector3"),dt=(a,t,m)=>at((u,s,{world:l,rapier:d})=>{const e=T(a)?a:new f(...a),r=T(t)?t:new f(...t),g=d.JointData.rope(m,e,r);return l.createImpulseJoint(g,u,s,!0)});function pt(a,t){Q(t,!0);let m=p(t,"startRigidBody",15),u=p(t,"lastRigidBody",15),s=p(t,"positions",15),l=j(()=>t.length/(t.segments-1)),d=q(!1);const e=j(()=>Array.from({length:t.segments-1},()=>dt([0,0,0],[0,0,0],c(l))));s(new Float32Array(t.segments));const r=I([]);_(()=>{m(r.at(0)),u(r.at(-1))});const g=I([]),V=new f().fromArray(t.ropeStart),z=new f().fromArray(t.ropeEnd),E=o=>{const n=o/(t.segments-1);return V.clone().lerp(z,n)};_(()=>{r.length!==t.segments||g.length!==t.segments||c(d)||(c(e).forEach((o,n)=>{o.rigidBodyA.set(r[n]),o.rigidBodyB.set(r[n+1])}),H(d,!0))}),I(Array.from({length:t.segments},()=>new f(0,0,0)));const y=new f;Z(()=>{var o;if(c(d))for(let n=0,i=0,B=g.length;n<B;n+=1,i+=3)(o=g[n])==null||o.getWorldPosition(y),s(s()[i+0]=y.x,!0),s(s()[i+1]=y.y,!0),s(s()[i+2]=y.z,!0)}),$(()=>[c(d),t.ropeStart,t.ropeEnd],([o])=>{var n;o&&((n=m())==null||n.setNextKinematicTranslation({x:t.ropeStart[0],y:t.ropeStart[1],z:t.ropeStart[2]}))});var P=h(),O=R(P);L(O,17,()=>({length:t.segments}),U,(o,n,i)=>{var B=h(),k=R(B);A(k,()=>D.Group,(C,Y)=>{Y(C,{oncreate:v=>{v.position.copy(E(i))},children:(v,mt)=>{rt(v,{get linearDamping(){return t.damping},get angularDamping(){return t.damping},type:i===0?"kinematicPosition":"dynamic",get rigidBody(){return r[i]},set rigidBody(w){r[i]=w},children:(w,ut)=>{var x=j(()=>[t.ballRadius]);it(w,{shape:"ball",get args(){return c(x)},children:(F,lt)=>{var S=h(),G=R(S);A(G,()=>D.Object3D,(K,M)=>{M(K,{get ref(){return g[i]},set ref(N){g[i]=N}})}),b(F,S)},$$slots:{default:!0}})},$$slots:{default:!0}})},$$slots:{default:!0}})}),b(o,B)}),b(a,P),W()}export{pt as default};
