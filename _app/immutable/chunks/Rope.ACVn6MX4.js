import"./disclose-version.Bg9kRutz.js";import{aF as G,p as Y,aD as ee,aE as te,u as m,f as I,$ as ne,a as H,d as Q,k as w,a3 as oe,a2 as re,m as S}from"./index-client.D_7LkImg.js";import{c as x,a as W}from"./template.AcjnxTEE.js";import{e as se,i as ie}from"./each.CPMWh782.js";import{c as J}from"./svelte-component.ClNcW8Uq.js";import{p as j,a as F}from"./props.BhoiTsxR.js";import{k as ae,V as f,$ as le,Q as O,e as K,ab as ce,ac as de,aa as ue,s as ge,o as me,T as V}from"./T.po24HVTg.js";import{Y as fe,R as ye,o as ve,A as k,e as we,g as Re,a as he}from"./createCollidersFromChildren.Cm4lVrJe.js";import{d as be,g as Ae,w as M}from"./index.7ttzKC12.js";import{u as N,a as Ce,b as Pe,c as Be,d as Ie,e as xe,R as We}from"./applyColliderActiveEvents.D2fXT2Oo.js";const je=r=>{const e=M(void 0),t=M(void 0),o=N(),l=be([e,t],([s,a])=>{if(s&&a)return[s,a]}),c=M(void 0),i=l.subscribe(s=>{s&&c.set(r(...s,o))});return G(()=>{i();const s=Ae(c);s&&(s instanceof fe?o.world.removeMultibodyJoint(s,!0):o.world.removeImpulseJoint(s,!0))}),{joint:c,rigidBodyA:e,rigidBodyB:t}},L=r=>ae(r,"Vector3"),De=(r,e,t)=>je((o,l,{world:c,rapier:i})=>{const s=L(r)?r:new f(...r),a=L(e)?e:new f(...e),g=i.JointData.rope(t,s,a);return c.createImpulseJoint(g,o,l,!0)}),Te=(r,e)=>{const t=Array.from(r);for(let o=0;o<r.length/3;o++)t[o*3]*=e.x,t[o*3+1]*=e.y,t[o*3+2]*=e.z;return t},_e=(r,e,t)=>{const o=e.slice();if(r==="heightfield")return o;if(r==="trimesh"||r==="convexHull")return o[0]=new Float32Array(Te(o[0],t)),o;const l=[t.x,t.y,t.z];return o.map((c,i)=>(l[i]??1)*c)};function Se(r,e){Y(e,!0);let t=j(e,"collider",15);const o=new le,{updateRef:l}=Ce(e.oncreate),c=Pe(),i=Be(),s=!!c,a=N(),{world:g}=a,b=Ie(),A={oncollisionenter:e.oncollisionenter,oncollisionexit:e.oncollisionexit,oncontact:e.oncontact,onsensorenter:e.onsensorenter,onsensorexit:e.onsensorexit};ee(async()=>{await te();const n=o.getWorldScale(new f),v=_e(e.shape,e.args,n),T=ye[e.shape](...v);if(t(g.createCollider(T,c)),t().setActiveCollisionTypes(ve.ALL),l(t()),a.addColliderToContext(t(),o,A),b.registerColliders([t()]),s){const B=new f,R=new O;i==null||i.getWorldPosition(B),i==null||i.getWorldQuaternion(R),R.invert();const h=o.getWorldPosition(new f).sub(B),z=o.getWorldQuaternion(new O).premultiply(R);t().setTranslationWrtParent(h),t().setRotationWrtParent(z)}else t().setTranslation(o.getWorldPosition(new f)),t().setRotation(o.getWorldQuaternion(new O))}),m(()=>{var n;(n=t())==null||n.setRestitution(e.restitution??0)}),m(()=>{var n;(n=t())==null||n.setRestitutionCombineRule(e.restitutionCombineRule??k.Average)}),m(()=>{var n;(n=t())==null||n.setFriction(e.friction??.7)}),m(()=>{var n;(n=t())==null||n.setFrictionCombineRule(e.frictionCombineRule??k.Average)}),m(()=>{var n;return(n=t())==null?void 0:n.setSensor(e.sensor??!1)}),m(()=>{var n;return(n=t())==null?void 0:n.setContactForceEventThreshold(e.contactForceEventThreshold??0)}),m(()=>{var n;e.density!==void 0&&((n=t())==null||n.setDensity(e.density))}),m(()=>{t()&&e.mass&&(e.centerOfMass&&e.principalAngularInertia&&e.angularInertiaLocalFrame?t().setMassProperties(e.mass,{x:e.centerOfMass[0],y:e.centerOfMass[1],z:e.centerOfMass[2]},{x:e.principalAngularInertia[0],y:e.principalAngularInertia[1],z:e.principalAngularInertia[2]},we(e.angularInertiaLocalFrame)):t().setMass(e.mass))}),m(()=>{var n;t()&&xe(t(),A,(n=c==null?void 0:c.userData)==null?void 0:n.events)});const C=()=>{t()&&(t().setTranslation(Re(o)),t().setRotation(he(o)))},{start:y,stop:P}=K(()=>{C()},{autoStart:!s&&e.type==="dynamic"});m(()=>{!s&&e.type==="dynamic"?y():P()}),G(()=>{t()&&(a.removeColliderFromContext(t()),b.removeColliders([t()]),g.removeCollider(t(),!0),t(void 0))});const D=ce();de(o),ue(D,n=>(n==null||n.add(o),()=>{n==null||n.remove(o)}));var d=x(),u=I(d);return ge(u,()=>e.children??ne,()=>({collider:t()})),W(r,d),H({refresh:C})}function Fe(r,e){Y(e,!0);let t=j(e,"startRigidBody",15),o=j(e,"lastRigidBody",15),l=j(e,"positions",15),c=S(()=>e.length/(e.segments-1)),i=oe(!1);const s=S(()=>Array.from({length:e.segments-1},()=>De([0,0,0],[0,0,0],w(c))));l(new Float32Array(e.segments));const a=F([]);Q(()=>{t(a.at(0)),o(a.at(-1))});const g=F([]),b=new f().fromArray(e.ropeStart),A=new f().fromArray(e.ropeEnd),C=d=>{const u=d/(e.segments-1);return b.clone().lerp(A,u)};Q(()=>{a.length!==e.segments||g.length!==e.segments||w(i)||(w(s).forEach((d,u)=>{d.rigidBodyA.set(a[u]),d.rigidBodyB.set(a[u+1])}),re(i,!0))}),F(Array.from({length:e.segments},()=>new f(0,0,0)));const y=new f;K(()=>{var d;if(w(i))for(let u=0,n=0,v=g.length;u<v;u+=1,n+=3)(d=g[u])==null||d.getWorldPosition(y),l(l()[n+0]=y.x,!0),l(l()[n+1]=y.y,!0),l(l()[n+2]=y.z,!0)}),me(()=>[w(i),e.ropeStart,e.ropeEnd],([d])=>{var u;d&&((u=t())==null||u.setNextKinematicTranslation({x:e.ropeStart[0],y:e.ropeStart[1],z:e.ropeStart[2]}))});var P=x(),D=I(P);se(D,17,()=>({length:e.segments}),ie,(d,u,n)=>{var v=x(),T=I(v);J(T,()=>V.Group,(B,R)=>{R(B,{oncreate:h=>{h.position.copy(C(n))},children:(h,z)=>{We(h,{get linearDamping(){return e.damping},get angularDamping(){return e.damping},type:n===0?"kinematicPosition":"dynamic",get rigidBody(){return a[n]},set rigidBody(_){a[n]=_},children:(_,Oe)=>{var q=S(()=>[e.ballRadius]);Se(_,{shape:"ball",get args(){return w(q)},children:(U,Me)=>{var E=x(),X=I(E);J(X,()=>V.Object3D,(Z,p)=>{p(Z,{get ref(){return g[n]},set ref($){g[n]=$}})}),W(U,E)},$$slots:{default:!0}})},$$slots:{default:!0}})},$$slots:{default:!0}})}),W(d,v)}),W(r,P),H()}const Ke=Object.freeze(Object.defineProperty({__proto__:null,default:Fe},Symbol.toStringTag,{value:"Module"}));export{Se as C,Fe as R,Ke as a};
