import"./DsnmJJEf.js";import{Z as N,ac as v,u as S,g as c,a5 as W,_ as w,a4 as H,aq as R,a0 as b,a1 as _,a2 as L}from"./Dj-DrZoY.js";import{e as Q,i as U}from"./oo0O6sVj.js";import{c as A}from"./DY0mOCK0.js";import{p as j}from"./HA0OJ1C7.js";import{g1 as X,V as f,fZ as Y,g5 as $,f_ as D}from"./C4vSLsTb.js";import{l as tt}from"./BmM3V0ga.js";import{d as et,w as p,a as rt,g as nt}from"./BA4cHdPC.js";import{c as st,R as ot}from"./wFOImlnq.js";import{C as at}from"./D_abKrUn.js";const it=a=>{const t=p(void 0),u=p(void 0),l=st(),s=et([t,u],([e,r])=>{if(e&&r)return[e,r]}),g=p(void 0),i=s.subscribe(e=>{e&&g.set(a(...e,l))});return rt(()=>{i();const e=nt(g);e&&(e instanceof tt?l.world.removeMultibodyJoint(e,!0):l.world.removeImpulseJoint(e,!0))}),{joint:g,rigidBodyA:t,rigidBodyB:u}},V=a=>X(a,"Vector3"),dt=(a,t,u)=>it((l,s,{world:g,rapier:i})=>{const e=V(a)?a:new f(...a),r=V(t)?t:new f(...t),m=i.JointData.rope(u,e,r);return g.createImpulseJoint(m,l,s,!0)});function _t(a,t){N(t,!0);let u=j(t,"startRigidBody",15),l=j(t,"lastRigidBody",15),s=j(t,"positions",15),g=w(()=>t.length/(t.segments-1)),i=W(!1);const e=w(()=>Array.from({length:t.segments-1},()=>dt([0,0,0],[0,0,0],c(g))));s(new Float32Array(t.segments));const r=v([]);S(()=>{u(r.at(0)),l(r.at(-1))});const m=v([]),z=new f().fromArray(t.ropeStart),E=new f().fromArray(t.ropeEnd),T=n=>{const o=n/(t.segments-1);return z.clone().lerp(E,o)};S(()=>{r.length!==t.segments||m.length!==t.segments||c(i)||(c(e).forEach((n,o)=>{n.rigidBodyA.set(r[o]),n.rigidBodyB.set(r[o+1])}),H(i,!0))}),v(Array.from({length:t.segments},()=>new f(0,0,0)));const y=new f;Y(()=>{if(c(i))for(let n=0,o=0,d=m.length;n<d;n+=1,o+=3)m[n]?.getWorldPosition(y),s(s()[o+0]=y.x,!0),s(s()[o+1]=y.y,!0),s(s()[o+2]=y.z,!0)}),$(()=>[c(i),t.ropeStart,t.ropeEnd],([n])=>{n&&u()?.setNextKinematicTranslation({x:t.ropeStart[0],y:t.ropeStart[1],z:t.ropeStart[2]})});var I=R(),k=b(I);Q(k,17,()=>({length:t.segments}),U,(n,o,d)=>{var J=R(),C=b(J);A(C,()=>D.Group,(O,Z)=>{Z(O,{oncreate:B=>{B.position.copy(T(d))},children:(B,ut)=>{ot(B,{get linearDamping(){return t.damping},get angularDamping(){return t.damping},type:d===0?"kinematicPosition":"dynamic",get rigidBody(){return r[d]},set rigidBody(h){r[d]=h},children:(h,lt)=>{{let q=w(()=>[t.ballRadius]);at(h,{shape:"ball",get args(){return c(q)},children:(x,gt)=>{var P=R(),F=b(P);A(F,()=>D.Object3D,(G,K)=>{K(G,{get ref(){return m[d]},set ref(M){m[d]=M}})}),_(x,P)},$$slots:{default:!0}})}},$$slots:{default:!0}})},$$slots:{default:!0}})}),_(n,J)}),_(a,I),L()}export{_t as default};
